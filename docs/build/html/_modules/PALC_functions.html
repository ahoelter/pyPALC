
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PALC_functions &#8212; pyPALC  documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyPALC  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PALC_functions</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PALC_functions</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">author: Arne Hoelter</span>

<span class="sd">This module contains function that are used in :py:meth:`calcPALC` and</span>
<span class="sd">:any:`calc_angles`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="c1">##    function is contained in the numpy.matlib module</span>
<span class="c1">#     for further information, see: https://github.com/numpy/numpy/blob/v1.13.0/numpy/matlib.py#L310-L358 </span>
<span class="c1">#</span>
<div class="viewcode-block" id="repmat"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.repmat">[docs]</a><span class="k">def</span> <span class="nf">repmat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot; Contained in numpy.matlib module,</span>
<span class="sd">        see https://github.com/numpy/numpy/blob/v1.13.0/numpy/matlib.py#L310-L358 &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">origrows</span><span class="p">,</span> <span class="n">origcols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">origrows</span><span class="p">,</span> <span class="n">origcols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">origrows</span><span class="p">,</span> <span class="n">origcols</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">origrows</span> <span class="o">*</span> <span class="n">m</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">origcols</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">origcols</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span></div>

<div class="viewcode-block" id="list_sort"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.list_sort">[docs]</a><span class="k">def</span> <span class="nf">list_sort</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sorts a sequence of lists. Actually not used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seq : list</span>
<span class="sd">        List to sort.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Sorted list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">seq</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_diff_tilt_angles"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_diff_tilt_angles">[docs]</a><span class="k">def</span> <span class="nf">calc_diff_tilt_angles</span><span class="p">(</span><span class="n">gamma_tilt_deg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the intercabinet tilt angles. Called by :any:`start_calc`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gamma_tilt_deg : ndarray</span>
<span class="sd">        Computed absolute tilt angles in degree.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Rounded intercabinet tilt angles and absolute tilt angles in degree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma_tilt_deg_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gamma_tilt_deg</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">gamma_tilt_deg_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_tilt_deg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gamma_tilt_deg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">gamma_tilt_deg_diff</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span>  <span class="n">gamma_tilt_deg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">gamma_tilt_deg</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gamma_tilt_deg_diff</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gamma_tilt_deg</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_progressive_array"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_progressive_array">[docs]</a><span class="k">def</span> <span class="nf">calc_progressive_array</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">gamma_LSA</span><span class="o">=</span><span class="p">[],</span> <span class="n">gamma_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gamma_f</span> <span class="o">=</span> <span class="mi">38</span><span class="p">,</span> <span class="n">use_dangles</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the absolute tilt angles of a progressive LSA curving. Called by</span>
<span class="sd">    :any:`ref_array_angles`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of loudspeaker array cabinets.</span>
<span class="sd">    gamma_LSA : list, optional</span>
<span class="sd">        Possible discrete intercabinet tilt angles, if use_dangles is set to</span>
<span class="sd">        &#39;Yes&#39;. The default is [].</span>
<span class="sd">    gamma_0 : float, optional</span>
<span class="sd">        Tilt angle of the highest (first) LSA cabinet in degree.</span>
<span class="sd">        The default is 0.</span>
<span class="sd">    gamma_f : float, optional</span>
<span class="sd">        Angle of the last tilt angle in degree. The default is 38.</span>
<span class="sd">    use_dangles : str, optional</span>
<span class="sd">        If discrete tilt angles shall be used: &#39;Yes&#39;. The default is &#39;No&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gamma_deg : ndarray</span>
<span class="sd">        Array with the progressive LSA curving in degree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>   
    <span class="c1"># calculate delta_gamma with given terminal angle gamma_f</span>
    <span class="n">delta_gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">gamma_f</span><span class="o">-</span><span class="n">gamma_0</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1">#delta_gamma = 7/N</span>
    <span class="c1"># calculate cabinet tilt angle for all LSA cabinets</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_0</span> <span class="o">+</span> <span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">delta_gamma</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gamma_LSA</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">use_dangles</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gamma_LSA</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_LSA</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gamma_deg</span></div>


<div class="viewcode-block" id="calc_arc_array"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_arc_array">[docs]</a><span class="k">def</span> <span class="nf">calc_arc_array</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">gamma_LSA</span><span class="o">=</span><span class="p">[],</span> <span class="n">gamma_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gamma_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">use_dangles</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the absolute tilt angles of an arc LSA curving. Called by</span>
<span class="sd">    :any:`ref_array_angles`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of loudspeaker array cabinets.</span>
<span class="sd">    gamma_LSA : list, optional</span>
<span class="sd">        Possible discrete intercabinet tilt angles, if use_dangles is set to</span>
<span class="sd">        &#39;Yes&#39;. The default is [].</span>
<span class="sd">    gamma_0 : float, optional</span>
<span class="sd">        Tilt angle of the highest (first) LSA cabinet in degree.</span>
<span class="sd">        The default is 0.</span>
<span class="sd">    gamma_delta : float, optional</span>
<span class="sd">        Angle of the intercabinet angles in degree. The default is 1.</span>
<span class="sd">    use_dangles : str, optional</span>
<span class="sd">        If discrete tilt angles shall be used: &#39;Yes&#39;. The default is &#39;No&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gamma_deg : ndarray</span>
<span class="sd">        Array with the progressive LSA curving in degree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gamma_LSA</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">use_dangles</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
        <span class="n">gamma_delta</span> <span class="o">=</span> <span class="n">gamma_LSA</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">gamma_LSA</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span><span class="o">-</span><span class="n">gamma_delta</span><span class="p">))]</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">gamma_deg</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_0</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">gamma_delta</span>
    <span class="k">return</span> <span class="n">gamma_deg</span></div>
    

<div class="viewcode-block" id="calc_gamma"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_gamma">[docs]</a><span class="k">def</span> <span class="nf">calc_gamma</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">psi_n</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_a_t_n</span><span class="p">,</span> <span class="n">Lambda_y</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a specific loudspeaker tilt angle of a LSA cabinet. Called by</span>
<span class="sd">    :any:`calc_angles`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gamma_n : ndarray</span>
<span class="sd">        Set of LSA tilt angles.</span>
<span class="sd">    psi_n : float</span>
<span class="sd">        Splay / aperture angle of the loudspeaker cabinets or of the m-th LS cabinet.</span>
<span class="sd">    x_start : float</span>
<span class="sd">        Highest point of the LSA cabinet in x-coordinate.</span>
<span class="sd">    y_start : float</span>
<span class="sd">        Highest point of the LSA cabinet in y-coordinate.</span>
<span class="sd">    x_a_t_n : float</span>
<span class="sd">        Top position of covered audience line by m-th LSA cabinet (x- and y-coordinate).</span>
<span class="sd">    Lambda_y : float</span>
<span class="sd">        Height of m-th LSA cabinet.</span>
<span class="sd">    m : int, optional</span>
<span class="sd">        Variable which LSA cabinet is optimized. The default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Tilt angle of m-th LSA cabinet in degree.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dx_an</span> <span class="o">=</span> <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_start</span>
        <span class="n">dy_an</span> <span class="o">=</span> <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_start</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dx_an</span> <span class="o">=</span> <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_start</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">dy_an</span> <span class="o">=</span> <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_start</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="n">A_an</span> <span class="o">=</span> <span class="n">dx_an</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">-</span> <span class="n">dy_an</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
    <span class="n">B_an</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx_an</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">-</span> <span class="n">dy_an</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
    <span class="n">C_an</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">Lambda_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">A_an</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">C_an</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A_an</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B_an</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="o">-</span><span class="n">B_an</span> <span class="o">/</span> <span class="n">A_an</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">C_an</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A_an</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">B_an</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="o">-</span><span class="n">B_an</span> <span class="o">/</span> <span class="n">A_an</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span></div>


<div class="viewcode-block" id="source_pos"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.source_pos">[docs]</a><span class="k">def</span> <span class="nf">source_pos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">PALC_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the positions of the LSA cabinets for a given tilt angles.</span>
<span class="sd">    Called by :any:`calc_angles`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gamma_n : ndarray</span>
<span class="sd">        Set of LSA tilt angles.</span>
<span class="sd">    PALC_config : obj</span>
<span class="sd">        Configuration of the PALC-algorithm.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_start : ndarray</span>
<span class="sd">        Highest points of LSA cabinets in x-coordinates.</span>
<span class="sd">    y_start : ndarray</span>
<span class="sd">        Highest points of LSA cabinets in y-coordinates.</span>
<span class="sd">    x_stop : ndarray</span>
<span class="sd">        Lowest points of LSA cabinets in x-coordinates.</span>
<span class="sd">    y_stop : ndarray</span>
<span class="sd">        Lowest points of LSA cabinets in y-coordinates.</span>
<span class="sd">    x_src : ndarray</span>
<span class="sd">        Center points of LSA cabinets in x-coordinates.</span>
<span class="sd">    y_src : ndarray</span>
<span class="sd">        Center points of LSA cabinets in y-coordinates.</span>
<span class="sd">    x_S : ndarray</span>
<span class="sd">        Center of the whole LSA in x-coordinates.</span>
<span class="sd">    y_S : ndarray</span>
<span class="sd">        Center of the whole LSA in y-coordinates.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize the information of the PALC_config list</span>
    <span class="n">Lambda_y</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span>
    <span class="n">Lambda_gap</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_gap</span>
    <span class="n">x_H</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">x_H</span>
    <span class="n">y_H</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">y_H</span>
    <span class="n">gamma_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># calculate the source positions</span>
    <span class="n">X</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Lambda_y</span> <span class="o">+</span> <span class="n">Lambda_gap</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Lambda_y</span> <span class="o">+</span> <span class="n">Lambda_gap</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span>
    <span class="n">X_start</span> <span class="o">=</span> <span class="n">repmat</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Y_start</span> <span class="o">=</span> <span class="n">repmat</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Y</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Y</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_start</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">x_H</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_H</span><span class="p">],[</span><span class="n">x_start</span><span class="p">])</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x_start</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y_start</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">y_H</span>
    <span class="n">y_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">y_H</span><span class="p">],[</span><span class="n">y_start</span><span class="p">])</span>
    <span class="n">y_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y_start</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_stop</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">-</span> <span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_stop</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">-</span> <span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_src</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">x_stop</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y_src</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_start</span> <span class="o">+</span> <span class="n">y_stop</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">x_S</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_stop</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_stop</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y_S</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_stop</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_stop</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">return</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_stop</span><span class="p">,</span> <span class="n">y_stop</span><span class="p">,</span> <span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">,</span> <span class="n">x_S</span><span class="p">,</span> <span class="n">y_S</span></div>

 
<div class="viewcode-block" id="calc_intersection_PAL"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_intersection_PAL">[docs]</a><span class="k">def</span> <span class="nf">calc_intersection_PAL</span><span class="p">(</span><span class="n">xy_1_a</span><span class="p">,</span> <span class="n">xy_1_b</span><span class="p">,</span> <span class="n">xy_2_a</span><span class="p">,</span> <span class="n">xy_2_b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates intersection points of the polygonal audience lines</span>
<span class="sd">    This function is necessary for the handling of gaps in the audience lines and</span>
<span class="sd">    is used to create the non-audience lines.</span>
<span class="sd">    Calculation of the intersection of two adjacent sections of the polygonal</span>
<span class="sd">    audience line based on the intersection of two linear functions in vector</span>
<span class="sd">    representation. Called by :any:`calc_angles`, :any:`pal_draw_condition_3`</span>
<span class="sd">    and :any:`suggestPAL`.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        * vec{OP_1} = vec{OA_1} + lambda_1 * ( vec{OB_1} - vec{OA_1} )</span>
<span class="sd">        * vec{OP_2} = vec{OA_2} + lambda_2 * ( vec{OB_2} - vec{OA_2} )</span>

<span class="sd">        * vec{OA_1} = [ xy_1_a(1) xy_1_a(2) ]</span>
<span class="sd">        * vec{OB_1} = [ xy_1_b(1) xy_1_b(2) ]</span>
<span class="sd">        * vec{OA_2} = [ xy_2_a(1) xy_2_a(2) ]</span>
<span class="sd">        * vec{OB_2} = [ xy_2_b(1) xy_2_b(2) ]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xy_1_a : list</span>
<span class="sd">        Start position (x, y) of the pal section 1.</span>
<span class="sd">    xy_1_b : list</span>
<span class="sd">        Stop position (x, y) of the pal section 1.</span>
<span class="sd">    xy_2_a : list</span>
<span class="sd">        Start position (x, y) of the pal section 2.</span>
<span class="sd">    xy_2_b : list</span>
<span class="sd">        Stop position (x, y) of the pal section 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xy_s : list</span>
<span class="sd">        Intersection (x, y) of pal section 1 and pal section 2.</span>
<span class="sd">    lambda_1 : float</span>
<span class="sd">        Vector parameter 1 for the intersection.</span>
<span class="sd">    lambda_2 : float</span>
<span class="sd">        Vector parameter 2 for the intersection.</span>
<span class="sd">    point_exist : bool</span>
<span class="sd">        True, if a point of intersection exists. Otherwise False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize</span>
    <span class="n">xy_s_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xy_s_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xy_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">slope_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">slope_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">slope_1</span> <span class="o">=</span> <span class="mi">5000</span>
        <span class="n">slope_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">slope_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">slope_2</span> <span class="o">=</span> <span class="mi">4900</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slope_1</span> <span class="o">=</span> <span class="mi">5000</span>
        <span class="n">slope_2</span> <span class="o">=</span> <span class="mi">4900</span>
    <span class="c1"># check if the slope of both lines is infinity or slope of both lines is equal</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> \
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slope_1</span> <span class="o">-</span> <span class="n">slope_2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)):</span>
        <span class="n">point_exist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lambda_1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lambda_2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xy_s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># calculate vector parameters lambda_1 and lambda_2 for the</span>
        <span class="c1"># intersection position</span>
        <span class="n">lambda_1</span> <span class="o">=</span> <span class="p">((</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> \
                   <span class="p">((</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        
        <span class="n">lambda_2</span> <span class="o">=</span> <span class="p">((</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> \
                   <span class="p">((</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>    
        
        <span class="c1"># calculate intersection position based on the computed lambda_1 for pal section 1</span>
        <span class="n">xy_s_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambda_1</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xy_s_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambda_1</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_1_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_1_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># calculate intersction position based on the computed lambda_2 for pal section 2</span>
        <span class="n">xy_s_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambda_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xy_s_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambda_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy_2_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_2_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># check of calculation: do the computed lambda_1 and lambda_2 result in the </span>
        <span class="c1"># same intersection position -- x-coordinates</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xy_s_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_s_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">xy_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_s_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xy_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># check of calculation: do the computed lambda_1 and lambda_2 result in the </span>
        <span class="c1"># same intersection position -- y-coordinates</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xy_s_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy_s_2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">xy_s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_s_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xy_s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">point_exist</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">return</span> <span class="n">xy_s</span><span class="p">,</span> <span class="n">lambda_1</span><span class="p">,</span> <span class="n">lambda_2</span><span class="p">,</span> <span class="n">point_exist</span></div>


<div class="viewcode-block" id="LSA_visualization"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.LSA_visualization">[docs]</a><span class="k">def</span> <span class="nf">LSA_visualization</span><span class="p">(</span><span class="n">PALC_plots</span><span class="p">,</span> <span class="n">PALC_config</span><span class="p">,</span> <span class="n">gamma_n</span><span class="p">,</span> <span class="n">N_margin</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the positions of the LSA cabinet edges to visualize them in a</span>
<span class="sd">    bokeh figure as patches. Called by :any:`start_calc`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    PALC_plots : obj [out]</span>
<span class="sd">        Contains plotting data of the PALC results.</span>
<span class="sd">    PALC_config : obj [in]</span>
<span class="sd">        Contains the PALC configuration.</span>
<span class="sd">    gamma_n : ndarray</span>
<span class="sd">        Absolute tilt angles of the LSA cabinets in degree.</span>
<span class="sd">    N_margin : int, optional</span>
<span class="sd">        If not all LSA cabinets shall be visualized. The default is [].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_patches : list</span>
<span class="sd">        x-coordinates of the LSA patches.</span>
<span class="sd">    y_patches : list</span>
<span class="sd">        y-coordinates of the LSA patches.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N_margin</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">N_margin</span>
    <span class="c1"># Array visualization</span>
    <span class="c1"># assign variables</span>
    <span class="n">x_start</span><span class="p">,</span> <span class="n">x_stop</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">y_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> \
                                       <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">x_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">x_H</span><span class="p">,</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">y_H</span>
    <span class="n">x_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">x_start</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_stop</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_gap</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y_start</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_stop</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_gap</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x_stop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_start</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">y_stop</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_start</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start</span><span class="p">,</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_stop</span> <span class="o">=</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">x_stop</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_start</span><span class="p">,</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_stop</span> <span class="o">=</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">y_stop</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start_b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span><span class="p">))</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_stop_b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_stop</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span><span class="p">))</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_start_b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span><span class="p">))</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_stop_b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_stop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span><span class="p">))</span>

    <span class="n">x_patches</span><span class="p">,</span> <span class="n">y_patches</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">x_patches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_stop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_stop_b</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">x_start_b</span><span class="p">[</span><span class="n">n</span><span class="p">]])</span>
        <span class="n">y_patches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_start</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_stop</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_stop_b</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">PALC_plots</span><span class="o">.</span><span class="n">y_start_b</span><span class="p">[</span><span class="n">n</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">x_patches</span><span class="p">,</span> <span class="n">y_patches</span></div>


<div class="viewcode-block" id="calc_angles"><a class="viewcode-back" href="../PALC_functions.html#PALC_functions.calc_angles">[docs]</a><span class="k">def</span> <span class="nf">calc_angles</span><span class="p">(</span><span class="n">PALC_plots</span><span class="p">,</span> <span class="n">pal</span><span class="p">,</span> <span class="n">psi_n</span><span class="p">,</span> <span class="n">gamma_n</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">PALC_config</span><span class="p">,</span> <span class="n">pal_e</span><span class="p">,</span> <span class="n">Opt_arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main routine of the PALC computation and is calles by :py:meth:`calcPALC`.</span>
<span class="sd">    Computes the tilt angles of the LSA cabinets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    PALC_plots : obj [out]</span>
<span class="sd">        Contains plotting data of the PALC results.</span>
<span class="sd">    pal : list</span>
<span class="sd">        All audience lines to be considered in PALC (audience lines,</span>
<span class="sd">        non-audience lines). Each element contains a audience line as a ndarray.</span>
<span class="sd">    psi_n : float</span>
<span class="sd">        Init splay angle for first PALC loop.</span>
<span class="sd">    gamma_n : ndarray</span>
<span class="sd">        Init tilt angles for the first iteration in radian.</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of LSA cabinets.</span>
<span class="sd">    PALC_config : obj [in]</span>
<span class="sd">        Contains PALC Configuration.</span>
<span class="sd">    pal_e : ndarray</span>
<span class="sd">        Audience lines without non-audience lines.</span>
<span class="sd">    Opt_arr : obj [out]</span>
<span class="sd">        Result of the PALC algorithm. Optimized LSA data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    try:</span>
    <span class="c1"># aud_l: length of each audience line segment</span>
    <span class="c1"># aud_angle: epsilon</span>
    <span class="c1"># aud_pos_seg</span>
    <span class="c1"># aud_length: total length of the audience line</span>
    <span class="n">aud_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">aud_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">aud_pos_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">aud_l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">aud_angle</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">n</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="c1">#aud_pos_seg[np.shape(pal)[0],:] = pal[np.shape(pal)[0]-1][np.shape(pal[np.shape(pal)[0]-1])[0]-1,:]</span>
    <span class="n">aud_pos_seg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">aud_pos_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">aud_pos_seg</span><span class="p">)</span>
    <span class="n">aud_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">aud_l</span><span class="p">)</span>
    <span class="n">aud_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">aud_length</span> <span class="o">=</span> <span class="n">aud_l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">aud_length_copy</span> <span class="o">=</span> <span class="n">aud_length</span>
    
    <span class="n">N_PALC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Gamma_aud</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fig_vs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">psi_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">N</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">N_opt_deg_flag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">aud_overlap</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># for discrete tilt angles: overlap on audience lines: to correct the error &#39;Gamma_aud&#39;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># just to test</span>
    
    <span class="c1">#### begin of the while-loop</span>
    <span class="k">while</span> <span class="p">(</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">tolerance</span> <span class="ow">or</span> <span class="p">(</span><span class="n">N_PALC</span> <span class="o">!=</span> <span class="n">N</span><span class="p">)</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_iter</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">)</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_iter</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">):</span>
    <span class="c1">#while num_iter == 0:</span>
        <span class="c1"># return if number of iteration reaches the maximum (declared above)</span>
        <span class="n">aud_overlap</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># for discrete tilt angles: overlap on audience lines: to correct the error &#39;Gamma_aud&#39;</span>
        <span class="k">if</span> <span class="n">num_iter</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">Opt_arr</span><span class="o">.</span><span class="n">num_iter</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="k">return</span>
            
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">seg_rem</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x_a_c_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">x_a_t_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">x_a_b_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">Gamma_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="c1">####### BEGIN ITERATION STEPS #######</span>
        <span class="k">if</span> <span class="n">num_iter</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">N_PALC</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">N_opt_deg_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">N_PALC</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">N_PALC</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_iter</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">N_PALC</span> <span class="o">==</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">N_opt_deg_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_iter</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">/</span> <span class="n">num_iter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">num_iter</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                    <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.00015</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.002</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Gamma_aud</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            
        
        <span class="n">N_PALC</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1">###### BEGIN FOR LOOP, one loop for every loudspeaker cabinet</span>
        
        <span class="c1"># use m instead of i (matlab code)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># (top position) x_PAL_k, Initialisierung, that highest LS cabinet beams on highest audience positions</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_fixed_angle</span> <span class="ow">or</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">last_angle_hm</span><span class="p">:</span> <span class="c1"># not not</span>
                    <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>
                    <span class="c1"># aud_l are the distances between x_PAL_k and x_PAL_k+1</span>
                    <span class="c1"># seg_rem = |x_a_t_n - x_PAL_k-1|                      </span>
                    <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>  
                    <span class="c1"># analytical Calculation of GammaTiltDeg_angle: </span>
                    <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_gamma</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">psi_n</span><span class="p">,</span> \
                       <span class="n">PALC_config</span><span class="o">.</span><span class="n">x_H</span><span class="p">,</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">y_H</span><span class="p">,</span> <span class="n">x_a_t_n</span><span class="p">,</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

                <span class="c1">############ FIXED FIRST ANGLE ############################</span>
                <span class="k">elif</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_fixed_angle</span><span class="p">:</span>
                    <span class="c1"># es muss</span>
                    <span class="c1"># gamma_n eingelesen werden - fertig</span>
                    <span class="c1"># 2. checken ob es einen schnittpunkt des obersten strahls mit pal gibt (strahl über gamma_n und psi_n)</span>
                    <span class="c1"># mit intersect funktion: x max wert von pal raussuchen und den strahl bis x max +1 laufen lassen</span>
                    <span class="c1"># 3. wenn nicht: pal vertikal einfügen sodass schnittpunkt existiert</span>
                    <span class="c1"># 4. wenn nicht: pal in aud_pos_seg einfügen</span>
                    <span class="c1"># 5. x_a_t_n berechnen </span>
                    <span class="k">if</span> <span class="n">num_iter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">aud_pos_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">aud_pos_seg</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">aud_pos_seg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
                        <span class="n">aud_length</span> <span class="o">-=</span> <span class="n">aud_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">aud_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">aud_l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">aud_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">num_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">aud_length</span> <span class="o">=</span> <span class="n">aud_length_copy</span>
                    <span class="c1"># get the fixed angle</span>
                    <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">fixed_angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

                    <span class="c1"># top direction of rays of the highest LS cabinet</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>  
                    <span class="n">hypo</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>   
                    <span class="n">direction_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
                    <span class="c1"># source position of the highest LS cabinet</span>
                    <span class="n">source_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">x_H</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">source_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">y_H</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># find maximum value on x-axis of pal and end point of ray</span>

                    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">pal</span><span class="p">)</span>
                    <span class="n">end_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">end_y</span> <span class="o">=</span> <span class="n">source_y</span> <span class="o">-</span> <span class="n">direction_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">-</span> <span class="n">source_x</span><span class="p">)</span>
                    <span class="c1"># find the intersection point if exists</span>
                    <span class="n">xy_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">point_exists1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>

                        <span class="n">xy_s1</span><span class="p">[</span><span class="n">o</span><span class="p">,:],</span> <span class="n">lambda_1</span><span class="p">,</span> <span class="n">lambda_2</span><span class="p">,</span> <span class="n">point_exists1</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">calc_intersection_PAL</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">source_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">end_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

                        <span class="k">if</span> <span class="n">point_exists1</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy_s1</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                           <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy_s1</span><span class="p">[</span><span class="n">o</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>

                            <span class="n">point_exists1</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">point_exists1</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># add a audience line if intersection point doesnt exist</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">source_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">direction_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">source_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">aud_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">aud_l</span><span class="p">)</span>
                        <span class="n">aud_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">aud_angle</span><span class="p">)</span>
                        <span class="n">aud_length</span> <span class="o">+=</span> <span class="n">aud_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">aud_pos_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]],</span> <span class="n">aud_pos_seg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> 
                        <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># case if the highest LS cabinet covers the last audience line</span>
                    <span class="k">elif</span> <span class="n">point_exists1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_s1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">),:]</span>
                        <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xy_s1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">),:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">aud_length</span> <span class="o">-=</span> <span class="p">(</span><span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">seg_rem</span><span class="p">)</span>
                        <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_s1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">),:]</span>
                    <span class="c1"># if the highest LS cabinet hits pal 0,1,...n-1: no convergence</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span>
                    
  
                <span class="c1"># Discrete angles if hard margin is used for possibly second computation</span>
                <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_gamma_LSA</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> \
                   <span class="ow">and</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_handling</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Hard Margin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">last_angle_hm</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">laste_angle_hm</span><span class="p">))</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">last_angle_hm</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_gamma</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">psi_n</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_a_t_n</span><span class="p">,</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">Lambda_y</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

                <span class="c1">################## DISCRETE TILT ANGLES ###################</span>
                <span class="k">if</span>  <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_gamma_LSA</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">######### Calculate The Tilt Angles By Usage Of The Set Of Discrete Tilt Angles #######</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gamma_LSA</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1">######### Shift Necessary Variables And Update k If Necessary ###########</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>  <span class="c1"># angle of direction to x_a_t_n of m-th loudspeaker</span>
                    <span class="n">hypo</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>    <span class="c1"># length if side adjacent is equal to one</span>
                    <span class="n">direction_y</span> <span class="o">=</span> <span class="n">hypo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="c1"># length in y direction if side adjacent (x direction)  is equal to one</span>
                    <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_stop</span><span class="p">,</span> <span class="n">y_stop</span><span class="p">,</span> <span class="n">x_c_n</span><span class="p">,</span> <span class="n">y_c_n</span><span class="p">,</span> <span class="n">x_S</span><span class="p">,</span> <span class="n">y_S</span> <span class="o">=</span> <span class="n">source_pos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">PALC_config</span><span class="p">)</span> <span class="c1"># source positions</span>
                    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">pal</span><span class="p">)</span>
                    <span class="n">end_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># max length in x direction</span>
                    <span class="n">end_y</span> <span class="o">=</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">direction_y</span> <span class="o">*</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">-</span> <span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="c1">#  max depth of y direction source_y - (end_x - source_x) / np.tan((np.pi/2) - (gamma_n[m]-psi_n[m]))</span>
                    <span class="n">xy_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">point_exists2</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># check in which pal segment is the intersection point</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">lambda_1</span><span class="p">,</span> <span class="n">lambda_2</span><span class="p">,</span> <span class="n">point_exists2</span> <span class="o">=</span> \
                        <span class="n">calc_intersection_PAL</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> \
                                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">end_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
                        <span class="k">if</span> <span class="n">point_exists2</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                           <span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">pal</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="c1"># check if current pal[o] is equal to current k</span>
                            <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
                                <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># new top position on audience line</span>
                                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># corrected segment remaining</span>
                                <span class="c1"># calc total overlap on audience line to correct Gamma_aud</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">aud_overlap</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">aud_overlap</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                            <span class="c1"># case if current pal[o] is on the pal segment above or rather on k-1</span>
                            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
                                <span class="n">aud_overlap</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># old k-th segment overlap</span>
                                <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c1"># update k</span>
                                <span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># angle of new pal segment</span>
                                <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># new top position on audience line</span>
                                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># corrected segment remaining</span>
                                <span class="n">aud_overlap</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># new k-th segment overlap</span>
                            <span class="c1"># case if current pal[o] is on the pal segment below or rather on k+1</span>
                            <span class="k">elif</span> <span class="n">o</span> <span class="o">==</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
                                <span class="n">aud_overlap</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># old k-th segment overlap</span>
                                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># update k</span>
                                <span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># angle of new pal segment</span>
                                <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># new top position on audience line</span>
                                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xy_s1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># corrected segment remaining</span>
                                <span class="n">aud_overlap</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># new k-th segment overlap</span>
                        
                    <span class="k">if</span> <span class="n">point_exists2</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in discrete tilt angles&#39;</span><span class="p">)</span>
                            <span class="k">return</span>
   
            <span class="c1">###############################################################################        </span>
            <span class="c1"># STEP 2: CALCULATE THE SOURCE POSITIONS  </span>
            <span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_stop</span><span class="p">,</span> <span class="n">y_stop</span><span class="p">,</span> <span class="n">x_c_n</span><span class="p">,</span> <span class="n">y_c_n</span><span class="p">,</span> <span class="n">x_S</span><span class="p">,</span> <span class="n">y_S</span> <span class="o">=</span> <span class="n">source_pos</span><span class="p">(</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">PALC_config</span><span class="p">)</span>
                
            <span class="c1">###############################################################################</span>
            <span class="c1"># STEP 3</span>
            
            <span class="c1"># center position of audience segment - epsilon for eq (15) JAES</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># eq (15) JAES</span>
            <span class="n">Xi_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> \
                           <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">seg_rem</span> <span class="o">&gt;=</span> <span class="n">Xi_1</span><span class="p">:</span> <span class="c1"># case (i) eq (16) in JAES</span>
                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">seg_rem</span> <span class="o">-</span> <span class="n">Xi_1</span>
                <span class="c1"># eq (17) JAES (aud_angle = epsilon_k)</span>
                <span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">Xi_1</span>
                <span class="n">psi_n_tilde</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># eq (18) JAES</span>
                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xi_1</span>
            <span class="k">elif</span> <span class="n">seg_rem</span> <span class="o">&lt;</span> <span class="n">Xi_1</span><span class="p">:</span>
                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_rem</span> <span class="c1"># first part of eq (23) JAES</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_t_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># distance for eq (20) JAES</span>
                <span class="c1"># eq (20) JAES</span>
                <span class="n">psi_n_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">seg_rem</span> <span class="o">/</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">-</span> \
                                         <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">seg_rem</span> <span class="o">/</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">epsilon</span> \
                                               <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])))</span>
            <span class="c1">########################## STEP IV ###########################################</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">aud_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">N_PALC</span> <span class="o">=</span> <span class="n">m</span>
                    <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">break</span>
            <span class="c1">####################### CONTINUE WITH STEP III ###############################</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="c1"># eq (21) JAES</span>
                <span class="n">Xi_tilde</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n_tilde</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
                <span class="c1"># eq (22) JAES</span>
                <span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">Xi_tilde</span>
                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xi_tilde</span>
                <span class="c1"># second part of eq (23) JAES</span>
                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Xi_tilde</span>
            <span class="c1">######################## STEP V #############################################</span>
    
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="c1"># stop position of audience segment</span>
            <span class="c1"># calculate psi, that it fits for PALC1, PALC2 or PALC3 ### CONSTRAINTS ###</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PALC 1&#39;</span><span class="p">]:</span>
                    <span class="c1"># for PALC1: psi = const.</span>
                    <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PALC 2&#39;</span><span class="p">]:</span>
                    <span class="c1"># psi * d = const. with weighting factor PALC_config[7]</span>
                    <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> \
                    <span class="o">/</span> <span class="p">(</span><span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PALC 3&#39;</span><span class="p">]:</span>
                    <span class="c1"># tan(psi) * d = const.</span>
                    <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> \
                    <span class="o">/</span> <span class="p">(</span><span class="n">d_array</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>    
            <span class="c1"># eq (24) JAES</span>
            <span class="n">Xi_2</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">seg_rem</span> <span class="o">&gt;=</span> <span class="n">Xi_2</span><span class="p">:</span> <span class="c1"># case (ii) eq (30) JAES</span>
                <span class="c1"># eq (31) JAES</span>
                <span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">x_a_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">Xi_2</span>
                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">seg_rem</span> <span class="o">-</span> <span class="n">Xi_2</span>
                <span class="n">psi_n_tilde</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xi_2</span> <span class="c1"># eq (32) JAES</span>
            <span class="k">elif</span> <span class="n">seg_rem</span> <span class="o">&lt;</span> <span class="n">Xi_2</span><span class="p">:</span> <span class="c1"># case (i) eq (23) JAES</span>
                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_rem</span> <span class="c1"># first part of eq (29) JAES</span>
                <span class="c1"># eq (26) JAES</span>
                <span class="n">psi_n_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">seg_rem</span> <span class="o">/</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">/</span> \
                                         <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">seg_rem</span> <span class="o">/</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">])))</span>
            <span class="c1">############################## STEP VI ########################################     </span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">aud_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">epsilon</span> <span class="o">=</span> <span class="o">-</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">N_PALC</span> <span class="o">=</span> <span class="n">m</span>
                    <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">break</span> 
            <span class="c1">########################### CONTINUE WITH STEP V #############################</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">-</span> <span class="p">[</span><span class="n">x_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_c_n</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="c1"># eq (27) JAES</span>
                <span class="n">Xi_tilde</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_n_tilde</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="n">gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_n</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
                <span class="n">seg_rem</span> <span class="o">=</span> <span class="n">aud_l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xi_tilde</span>
                <span class="c1"># eq (28) JAES</span>
                <span class="n">x_a_b_n</span><span class="p">[</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">aud_pos_seg</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aud_angle</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">Xi_tilde</span>
                <span class="c1"># second part of eq (29) JAES</span>

                <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gamma_n</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">Xi_tilde</span>
        <span class="c1">####################### END OF FOR-LOOP ####################################### </span>

        <span class="k">if</span> <span class="n">N_PALC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">N_PALC</span> <span class="o">=</span> <span class="n">N</span>
            <span class="n">psi_N</span> <span class="o">=</span> <span class="n">psi_n</span>
        
        <span class="c1">######### PLOT ################################################################</span>
            
        <span class="n">lin_eq_n</span> <span class="o">=</span> <span class="n">y_c_n</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="o">-</span><span class="n">gamma_n</span><span class="p">[:])</span> <span class="o">*</span> <span class="n">x_c_n</span>
        <span class="n">x_fin_unitn</span> <span class="o">=</span> <span class="n">x_a_c_n</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_fin_unitn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="o">-</span><span class="n">gamma_n</span><span class="p">[:])</span> <span class="o">*</span> <span class="n">x_fin_unitn</span> <span class="o">+</span> <span class="n">lin_eq_n</span>
        <span class="k">if</span> <span class="n">psi_n</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">psi_n</span> <span class="o">=</span> <span class="n">psi_n</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># update optimized LSA</span>
        <span class="n">Opt_arr</span><span class="o">.</span><span class="n">update_opt_array</span><span class="p">(</span><span class="n">x_c_n</span><span class="o">=</span><span class="n">x_c_n</span><span class="p">,</span> <span class="n">y_c_n</span><span class="o">=</span><span class="n">y_c_n</span><span class="p">,</span> <span class="n">x_a_c_n</span><span class="o">=</span><span class="n">x_a_c_n</span><span class="p">,</span> \
                                 <span class="n">x_a_t_n</span><span class="o">=</span><span class="n">x_a_t_n</span><span class="p">,</span> <span class="n">x_a_b_n</span><span class="o">=</span><span class="n">x_a_b_n</span><span class="p">,</span> \
                                 <span class="n">gamma_n</span><span class="o">=</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">psi_n</span><span class="o">=</span><span class="n">psi_n</span><span class="p">)</span>

        <span class="c1">############################### Soft Margin Approach for gap handling #########################</span>
        <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_handling</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Soft Margin&#39;</span><span class="p">]:</span>            
            <span class="c1"># First step: Find the added non audience line with pal and pal_e (indice)</span>
            <span class="n">ind_na_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_fixed_angle</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">point_exists1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">o</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">pal_e</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pal_e</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ind_na_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_na_line</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="c1"># Second step: check which loudspeaker hits which line on which point and </span>
            <span class="c1">#              add the weighting</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">ind_na_line</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                           <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                               <span class="c1"># compute the length of non-audience line and</span>
                               <span class="c1"># distance of deg_opt to next audience line</span>
                            <span class="n">dist_na_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                                                      <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">dist_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                                                   <span class="p">(</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">dist_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                                                  <span class="p">(</span><span class="n">Opt_arr</span><span class="o">.</span><span class="n">seg_pos</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pal</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">dist_near</span> <span class="o">=</span> <span class="n">dist_low</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dist_near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">([</span><span class="n">dist_high</span><span class="p">,</span> <span class="n">dist_low</span><span class="p">])</span>
                            <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_weights</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">strength_sm</span><span class="o">*</span><span class="p">(</span><span class="n">dist_near</span><span class="o">/</span><span class="n">dist_na_line</span><span class="p">)</span>
                                               
        <span class="c1">###### Iterative optimization of weighting_nu may be done here!!!</span>
        <span class="c1">###### weighting factors calculation with special case if fixed angles, soft margin and weighting</span>
        <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_fixed_angle</span> <span class="ow">and</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_handling</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Soft Margin&#39;</span><span class="p">]</span> \
           <span class="ow">and</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_nu</span> <span class="o">&lt;=</span> <span class="mf">1.02</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">use_weighting</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Without&#39;</span><span class="p">]:</span>
            <span class="n">elsecase</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PALC_config</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_weights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elsecase</span><span class="p">:</span>
                    <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_weights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elsecase</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_weights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_weights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">elsecase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_factors</span> <span class="o">=</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">gap_weights</span> <span class="o">*</span> <span class="n">PALC_config</span><span class="o">.</span><span class="n">weighting_weights</span>
            
            <span class="c1"># For future: may add some weighting for intersect points near to non-audience lines</span>
        <span class="c1">###############################################################################################</span>
        <span class="c1"># plot function! not optimized for plotting during calculation -&gt; one plot at the end</span>
        
        <span class="c1">######### update output + variables ###########################################</span>
        
        <span class="n">gamma_tilt_deg</span> <span class="o">=</span> <span class="n">gamma_n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">aud_pos_seg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">x_a_b_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">Gamma_aud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Gamma_n</span><span class="p">[:,:])</span> <span class="o">-</span> <span class="n">aud_length</span> <span class="o">-</span> <span class="n">aud_overlap</span>

        <span class="n">thr_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_a_c_n</span><span class="p">[:,:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_c_n</span><span class="p">[:],</span> <span class="n">y_c_n</span><span class="p">[:],</span> <span class="n">x_c_n</span><span class="p">[:]</span><span class="o">*</span><span class="mi">0</span><span class="p">])))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">num_iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">#PALC_plots  = PALC_classes.PALC_plotting()</span>
    <span class="n">PALC_plots</span><span class="o">.</span><span class="n">update_plot_array</span><span class="p">(</span><span class="n">x_c_n</span><span class="o">=</span><span class="n">x_c_n</span><span class="p">,</span> <span class="n">y_c_n</span><span class="o">=</span><span class="n">y_c_n</span><span class="p">,</span> <span class="n">x_fin_unitn</span><span class="o">=</span><span class="n">x_fin_unitn</span><span class="p">,</span> <span class="n">y_fin_unitn</span><span class="o">=</span><span class="n">y_fin_unitn</span><span class="p">)</span>
    <span class="n">Opt_arr</span><span class="o">.</span><span class="n">update_opt_array</span><span class="p">(</span><span class="n">gamma_n</span><span class="o">=</span><span class="n">gamma_n</span><span class="p">,</span> <span class="n">psi_n</span><span class="o">=</span><span class="n">psi_n</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="n">num_iter</span><span class="p">,</span> \
                             <span class="n">Gamma_aud</span><span class="o">=</span><span class="n">Gamma_aud</span><span class="p">,</span> <span class="n">thr_dist</span> <span class="o">=</span> <span class="n">thr_dist</span><span class="p">,</span> \
                             <span class="n">gamma_tilt_deg</span><span class="o">=</span><span class="n">gamma_tilt_deg</span><span class="p">)</span>
  
    <span class="c1"># set new gamma_n</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">PALC_config</span><span class="p">,</span><span class="s1">&#39;gamma_n&#39;</span><span class="p">,</span><span class="n">gamma_n</span><span class="p">)</span>
    <span class="k">return</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyPALC  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PALC_functions</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Arne Hoelter.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.1.
    </div>
  </body>
</html>